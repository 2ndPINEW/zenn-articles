---
title: "ChatGPTã‚’ã¬ã‚‹ã¬ã‚‹ã«ã™ã‚‹ğŸŒServer-Sent Eventsã®åŸºç¤çŸ¥è­˜"
emoji: "ğŸŒ"
type: "tech"
topics:
  - "http"
published: true
published_at: "2023-04-21 10:22"
publication_name: "chot"
---

## ã¯ã˜ã‚ã«

ChatGPT ã‚’ä½¿ã£ã¦ã„ã‚‹æ™‚ã«ã€ä¸‹è¨˜ã® gif ã®å·¦å´ã®ã‚ˆã†ãªæ„Ÿã˜ã§æ–‡å­—ãŒã©ã‚“ã©ã‚“å‡ºã¦ãã‚‹è¡¨ç¤ºã«é¦´æŸ“ã¿ãŒã‚ã‚‹ã¨æ€ã„ã¾ã™ã€‚
å³å´ã®ä¾‹ã¨æ¯”ã¹ã‚‹ã¨æ–‡ç« ãŒå…¨ã¦è¡¨ç¤ºã•ã‚Œã‚‹ã¾ã§ã®æ™‚é–“ã¯åŒã˜ãªã®ã§ã™ãŒã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ãŒå…¨ç„¶é•ã†ã¨æ€ã„ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/473d9126722f-20230418.gif)

ä»Šå›ã¯ã“ã®è¡¨ç¤ºã‚’æ”¯ãˆã‚‹ã€**Server-Sent Events**(ä»¥ä¸‹**SSE**)ã‚’ç´¹ä»‹ã—ã¦ã„ãã¾ã™ã€‚

## SSE ã£ã¦ã©ã‚“ãªæŠ€è¡“ï¼Ÿ

**SSE**ã¯ã€æ—¥æœ¬èªã§è¡¨ç¾ã™ã‚‹ã¨[ã‚µãƒ¼ãƒé€ä¿¡ã‚¤ãƒ™ãƒ³ãƒˆ](https://developer.mozilla.org/ja/docs/Web/API/Server-sent_events)ã¨è¡¨ç¾ã•ã‚Œã‚‹ã‚‚ã®ã§ã€ã‚µãƒ¼ãƒã‹ã‚‰ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«å¯¾ã—ã¦ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ã‚¤ãƒ™ãƒ³ãƒˆã‚’é€ä¿¡ã™ã‚‹ã“ã¨ãŒã§ãã‚‹æ©Ÿèƒ½ã§ã™ã€‚

ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ã‚’å¼µã£ã¦ãŠã„ã¦ã€ã‚µãƒ¼ãƒã‹ã‚‰ã‚¤ãƒ™ãƒ³ãƒˆã‚’å¥½ããªã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§é€ã‚Œã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã™ï¼
![](https://storage.googleapis.com/zenn-user-upload/c392ae23ac12-20230420.webp)
å¼•ç”¨: https://ably.com/blog/websockets-vs-sse

ChatGPT ã§ã¯ã€1 token ç”Ÿæˆã™ã‚‹ã”ã¨ã«ã€ã‚µãƒ¼ãƒã‹ã‚‰ç”Ÿæˆã—ãŸæ–‡å­—åˆ—ã‚’å«ã‚“ã ã‚¤ãƒ™ãƒ³ãƒˆã‚’é€ä¿¡ã™ã‚‹ã“ã¨ã§ã€æ–‡ç« ãŒã©ã‚“ã©ã‚“è¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ãªè¡¨ç¤ºã‚’ã—ã¦ã„ã¾ã™ã€‚

### ä»–ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šä¿¡æŠ€è¡“ã¨ã¯ä½•ãŒé•ã†ã®ï¼Ÿ

ãƒ–ãƒ©ã‚¦ã‚¶ã§ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šä¿¡ã‚’æ”¯ãˆã‚‹æŠ€è¡“ã¨ã—ã¦ã€WebSocket ãŒæ€ã„ã¤ã„ãŸã®ã§æ¯”è¼ƒã—ã¦ã¿ã¾ã™ã€‚

|              | SSE                                        | WebSocket                          |
| ------------ | ------------------------------------------ | ---------------------------------- |
| é€šä¿¡æ–¹å¼     | ã‚µãƒ¼ãƒã‹ã‚‰ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«å¯¾ã—ã¦ã®å˜æ–¹å‘é€šä¿¡ | ã‚µãƒ¼ãƒã¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆé–“ã§åŒæ–¹å‘é€šä¿¡ |
| ãƒ‡ãƒ¼ã‚¿å½¢å¼   | ãƒ†ã‚­ã‚¹ãƒˆã®ã¿                               | ãƒ†ã‚­ã‚¹ãƒˆã¨ãƒã‚¤ãƒŠãƒªãƒ‡ãƒ¼ã‚¿           |
| å®Ÿè£…ã®ç°¡å˜ã• | HTTP/1.1 ä¸Šã§å‹•ä½œã™ã‚‹ã®ã§ç°¡å˜              | ç‹¬è‡ªãƒ—ãƒ­ãƒˆã‚³ãƒ«ãªã®ã§å®Ÿè£…ãŒé›£ã—ã„   |
| å†æ¥ç¶š       | åŸºæœ¬è‡ªå‹•ã§ã—ã¦ãã‚Œã‚‹                       | è‡ªåˆ†ã§å®Ÿè£…ã—ãªã„ã¨ãƒ€ãƒ¡             |

å˜æ–¹å‘é€šä¿¡ã§ã‚ã‚‹ã¨ã„ã†ã“ã¨ã¨ã€**HTTP/1.1**ä¸Šã§å‹•ä½œã—ã¦ã„ã‚‹ã®ãŒå¤§ããªç‰¹å¾´ã§ã™ã€‚
ã¾ãŸã€**HTTP**ä¸Šã§å‹•ä½œã™ã‚‹ã“ã¨ã‹ã‚‰ã€é€šä¿¡ã®äº’æ›æ€§ãŒé«˜ãã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¢ãƒ‡ãƒ«ã‚‚ä½¿ã„ã¾ã‚ã›ã‚‹ã®ã§å®‰å¿ƒã§ã™ã€‚

### ã©ã‚“ãªç”¨é€”ã¨ç›¸æ€§ãŒã„ã„ã®ï¼Ÿ

åŒæ–¹å‘é€šä¿¡ãŒã—ãŸã„ã‚ã‘ã§ãªã‘ã‚Œã°ã€ç›¸æ€§ã®å¹…ãŒã¨ã¦ã‚‚åºƒã„ã§ã™ã€‚

ä»Šå›ã® ChatGPT ã®ã‚ˆã†ãªã€GPT ãŒãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç”Ÿæˆã™ã‚‹ã”ã¨ã«é€ã‚‹ã‚±ãƒ¼ã‚¹ã¯ã‚‚ã¡ã‚ã‚“ã€é€šçŸ¥ã®æœªèª­ä»¶æ•°ãƒãƒƒã‚¸ã®æ›´æ–°ã€ãƒ‹ãƒ¥ãƒ¼ã‚¹é€Ÿå ±ã®è¡¨ç¤ºãªã©ã€ã‚µãƒ¼ãƒã‹ã‚‰ã‚¤ãƒ™ãƒ³ãƒˆã‚’é€ã‚ŠãŸã„æ™‚ãªã‚‰ãªã‚“ã§ã‚‚ä½¿ãˆã¾ã™ã€‚

## **HTTP/1.1**ã§å‹•ãã‚«ãƒ©ã‚¯ãƒª

**SSE**ã¯**HTTP**ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ˜ãƒƒãƒ€ã«**Content-Type: text/event-stream**ã‚’æŒ‡å®šã—ãŸä¸Šã§å‹•ä½œã—ã¾ã™ã€‚

### **SSE**ãŒå‹•ãæµã‚Œ

1. ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒã‚µãƒ¼ãƒãƒ¼ã« HTTP/1.1 ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã€ã‚¤ãƒ™ãƒ³ãƒˆã‚¹ãƒˆãƒªãƒ¼ãƒ ã«æ¥ç¶šã—ã¾ã™ã€‚
2. ã‚µãƒ¼ãƒãƒ¼ã¯ã€Keep-Alive æ¥ç¶šã‚’ä½¿ç”¨ã—ã¦ã€TCP æ¥ç¶šã‚’ç¶­æŒã—ã¾ã™ã€‚
3. ã‚µãƒ¼ãƒãƒ¼ã¯ã€ãƒãƒ£ãƒ³ã‚¯è»¢é€ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’ä½¿ç”¨ã—ã¦ã€ã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«é€æ¬¡çš„ã«é€ä¿¡ã—ã¾ã™ã€‚
4. ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯ã€ã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å—ä¿¡ã—ã¦å‡¦ç†ã—ã¾ã™ã€‚ã“ã®é–“ã€TCP æ¥ç¶šã¯ç¶­æŒã•ã‚Œç¶šã‘ã¾ã™ã€‚
5. ã‚µãƒ¼ãƒãƒ¼ã¯ã€æ–°ã—ã„ã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ãŒåˆ©ç”¨å¯èƒ½ã«ãªã‚‹ãŸã³ã«ã€ãã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒãƒ£ãƒ³ã‚¯ã¨ã—ã¦é€ä¿¡ã—ç¶šã‘ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«ãƒ—ãƒƒã‚·ãƒ¥ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
6. ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒåˆ‡æ–­ã•ã‚Œã‚‹ã‹ã€ã‚µãƒ¼ãƒãƒ¼ãŒæ˜ç¤ºçš„ã«æ¥ç¶šã‚’é–‰ã˜ã‚‹ã¾ã§ã€ã‚¤ãƒ™ãƒ³ãƒˆã‚¹ãƒˆãƒªãƒ¼ãƒ ã¯ç¶­æŒã•ã‚Œã¾ã™ã€‚

ã“ã‚“ãªæµã‚Œã§å‹•ä½œã—ã¦ã„ã¦ã€**ãƒãƒ£ãƒ³ã‚¯è»¢é€ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°**ã¨**Keep-Alive æ¥ç¶š**ãŒä»Šå›ã®ãƒŸã‚½ã§ã™ã€‚

### ãƒãƒ£ãƒ³ã‚¯è»¢é€ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã¨ Keep-Alive

é€šå¸¸**HTTP**é€šä¿¡ã§ã¯ã€ã‚µãƒ¼ãƒã‹ã‚‰å¿œç­”ã‚’è¿”ã™ã¨ãã«ã€**HTTP ãƒ˜ãƒƒãƒ€**ã«**Content-Length**ã¨ã„ã†é€ä¿¡ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã®å¤§ãã•ã®æƒ…å ±ã‚’å«ã‚ã¦ã„ã¾ã™ã€‚
**SSE**ã‚’ä½¿ã†æ™‚ã¯ã€**HTTP ãƒ˜ãƒƒãƒ€**ã«**Content-Length**ã‚’è¨˜è¼‰ã›ãšã«ã€ä»£ã‚ã‚Šã«**Transfer-Encoding: chunked**ã‚’æŒ‡å®šã—ã¦ã€ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ã‚’è²¼ã£ãŸã¾ã¾ã«ã™ã‚‹ã“ã¨ã§ãƒ‡ãƒ¼ã‚¿ã‚’ãƒãƒ£ãƒ³ã‚¯å½¢å¼ã§é€ã‚‹ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

**HTTP/1.0**ã®æ™‚ã«ã¯ã€**Content-Length**ã‚’è¨˜è¼‰ã—ãªã‹ã£ãŸå ´åˆã€TCP ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ã®çµ‚äº†æ™‚ã«ãƒãƒ£ãƒ³ã‚¯ã®è»¢é€ãŒçµ‚äº†ã—ãŸæ‰±ã„ã«ãªã£ã¦ã—ã¾ã„ã€å®Ÿéš›ã«ã¯é€šä¿¡ãŒæ„å›³ã›ãšåˆ‡æ–­ã•ã‚Œã¦ã‚‚è»¢é€ãŒå®Œäº†ã—ãŸã¨æ‰±ã‚ã‚Œã¦ã—ã¾ã„ã¾ã—ãŸã€‚
**HTTP/1.1**ã®**Transfer-Encoding: chunked**ã§ã¯ã€æœ€å¾Œã«ç©ºã®ãƒãƒ£ãƒ³ã‚¯ã¨æ”¹è¡Œã‚³ãƒ¼ãƒ‰ã‚’é€ã‚‹ã“ã¨ã§ã€æ­£å¸¸ã«è»¢é€ãŒå®Œäº†ã—ãŸã‹åˆ¤åˆ¥ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚
ã“ã®ä»•æ§˜ã«ã‚ˆã£ã¦ã€**Keep-Alive**ã§ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ã‚’ç¶­æŒã—ãŸã¾ã¾ã€ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§é€ã‚‹ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

## ã©ã‚“ãªãƒ‡ãƒ¼ã‚¿ã‚’ã‚„ã‚Šå–ã‚Šã—ã¦ã‚‹ï¼Ÿï¼Ÿ

**SSE**ã§é€ä¿¡ã™ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã‚¹ãƒˆãƒªãƒ¼ãƒ ã¯ã€å˜ç´”ãªãƒ†ã‚­ã‚¹ãƒˆå½¢å¼ã§ã€UTF-8 ã§ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã¾ã™ã€‚
å„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯æ”¹è¡Œæ–‡å­—ã§åŒºåˆ‡ã‚‰ã‚Œã¦ã„ã¦ã€ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åã¨å€¤ã®ãƒšã‚¢ã«ãªã‚Šã¾ã™ã€‚

### ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰

ãƒ‡ãƒ¼ã‚¿æœ¬æ–‡ã‚’å«ã‚ã‚‹ãŸã‚ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã§ã™ã€‚
ãŸã ãƒ‡ãƒ¼ã‚¿ã‚’æµã—ãŸã„ã ã‘ã®å ´åˆã¯ã“ã®ã‚ˆã†ãªã‚¤ãƒ™ãƒ³ãƒˆã‚¹ãƒˆãƒªãƒ¼ãƒ ã§å®Ÿç¾ã§ãã¾ã™ã€‚

```javascript
data: ã“ã“ã«æ–‡å­—åˆ—å½¢å¼ã®ãƒ‡ãƒ¼ã‚¿ãŒå…¥ã‚Šã¾ã™;
```

### ã‚¤ãƒ™ãƒ³ãƒˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰

æŒ‡å®šã—ãŸã‚¤ãƒ™ãƒ³ãƒˆåã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’é€ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã‚Œã‚’æŒ‡å®šã—ãŸå ´åˆã¯ã€`addEventListener(ã‚¤ãƒ™ãƒ³ãƒˆå)`ã§æŒ‡å®šã—ãŸãƒªã‚¹ãƒŠãƒ¼ã«ã‚¤ãƒ™ãƒ³ãƒˆãŒé€ã‚‰ã‚Œã¾ã™ã€‚

```javascript
event: aweasome - event;
data: aweasome - eventã®ãƒ‡ãƒ¼ã‚¿;
```

### ID ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰

ID ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ä¸€æ„ãª ID ã‚’ä¸ãˆã‚‹ã“ã¨ã§ã€å†æ¥ç¶šæ™‚ã«ã©ã“ã¾ã§ã‚¤ãƒ™ãƒ³ãƒˆã‚’å—ä¿¡ã§ãã¦ã„ãŸã‹ã‚’ã‚µãƒ¼ãƒã«çŸ¥ã‚‰ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```javascript
id: 123;
data: ID123ã®ãƒ‡ãƒ¼ã‚¿;
```

### Retry ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰

æ¥ç¶šãŒåˆ‡ã‚ŒãŸå ´åˆã«ã€å†æ¥ç¶šã‚’è©¦ã¿ã‚‹ã¾ã§ã®æ™‚é–“ã§ã™ã€‚

```javascript
retry: 5000
data: 5ç§’å¾Œã«å†æ¥ç¶šã‚’ã—ã‚ˆã†ã¨ã—ã¾ã™ã€‚
```

## GPT ã‹ã‚‰ã‚¤ãƒ™ãƒ³ãƒˆã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’å—ä¿¡ã—ã¦ã¿ã‚‹ ğŸ¤–

GPT ã® API ã‚’ cURL ã§å©ã„ã¦ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¦‹ã¦ã¿ã¾ã™ã€‚

ã¾ãšã¯ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ API ã‚’å©ãã¾ã™ã€**stream: true**ã¨ã™ã‚‹ã¨ã€**SSE**ã‚’ä½¿ã£ã¦ãã‚Œã¾ã™ã€‚

```shell:ã‚³ãƒãƒ³ãƒ‰
curl 'https://api.openai.com/v1/chat/completions' \
  -H 'accept: text/event-stream' \
  -H 'authorization: Bearer sk-xxxx' \
  -H 'content-type: application/json' \
  -d '{
    "model": "gpt-3.5-turbo",
    "messages": [{"role": "user", "content": "ã“ã‚“ã«ã¡ã¯"}],
    "stream": true
  }'\
  --verbose
```

ã¾ãšã¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡éƒ¨åˆ†ã®ãƒ­ã‚°ã§ã™ã€ã“ã“ã¯æœ¬é¡Œã§ã¯ãªã„ã®ã§æµã—ã¾ã™ã€‚

```shell:ãƒªã‚¯ã‚¨ã‚¹ãƒˆéƒ¨åˆ†ã®ãƒ­ã‚°
*   Trying 104.18.6.192:443...
* Connected to api.openai.com (104.18.6.192) port 443 (#0)
* ALPN: offers h2
* ALPN: offers http/1.1
*  CAfile: /etc/ssl/cert.pem
*  CApath: none
* (304) (OUT), TLS handshake, Client hello (1):
* (304) (IN), TLS handshake, Server hello (2):
* (304) (IN), TLS handshake, Unknown (8):
* (304) (IN), TLS handshake, Certificate (11):
* (304) (IN), TLS handshake, CERT verify (15):
* (304) (IN), TLS handshake, Finished (20):
* (304) (OUT), TLS handshake, Finished (20):
* SSL connection using TLSv1.3 / AEAD-CHACHA20-POLY1305-SHA256
* ALPN: server accepted h2
* Server certificate:
*  subject: C=US; ST=California; L=San Francisco; O=Cloudflare, Inc.; CN=sni.cloudflaressl.com
*  start date: Mar 28 00:00:00 2023 GMT
*  expire date: Mar 26 23:59:59 2024 GMT
*  subjectAltName: host "api.openai.com" matched cert's "api.openai.com"
*  issuer: C=US; O=Cloudflare, Inc.; CN=Cloudflare Inc ECC CA-3
*  SSL certificate verify ok.
* Using HTTP2, server supports multiplexing
* Copying HTTP/2 data in stream buffer to connection buffer after upgrade: len=0
* h2h3 [:method: POST]
* h2h3 [:path: /v1/chat/completions]
* h2h3 [:scheme: https]
* h2h3 [:authority: api.openai.com]
* h2h3 [user-agent: curl/7.86.0]
* h2h3 [accept: text/event-stream]
* h2h3 [authorization: Bearer sk-xxxx]
* h2h3 [content-type: application/json]
* h2h3 [content-length: 120]
* Using Stream ID: 1 (easy handle 0x15280a800)
> POST /v1/chat/completions HTTP/2
> Host: api.openai.com
> user-agent: curl/7.86.0
> accept: text/event-stream
> authorization: Bearer sk-xxxx
> content-type: application/json
> content-length: 120
>
```

ã“ã“ã‹ã‚‰ãŒãƒ¬ã‚¹ãƒãƒ³ã‚¹éƒ¨åˆ†ã®ãƒ­ã‚°ã§ã™ã€‚
ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®é€ä¿¡ãŒå®Œäº†ã—ã¦ã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã£ã¦ãã¾ã—ãŸã€‚
ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ˜ãƒƒãƒ€ã« **content-type: text/event-stream**ã®ã¿å«ã¾ã‚Œã¦ã„ã¦ã€**Content-Length**ã«é–¢ã™ã‚‹æƒ…å ±ã¯ãªã•ãã†ã§ã™ã€‚

```shell:ãƒ¬ã‚¹ãƒãƒ³ã‚¹éƒ¨åˆ†ã®ãƒ­ã‚°
* We are completely uploaded and fine
* Connection state changed (MAX_CONCURRENT_STREAMS == 256)!
< HTTP/2 200
< date: Thu, 20 Apr 2023 05:37:26 GMT
< content-type: text/event-stream
< access-control-allow-origin: *
< cache-control: no-cache, must-revalidate
< openai-model: gpt-3.5-turbo-0301
< openai-organization: user-49wr72zyvpsevffsfnrcxvyd
< openai-processing-ms: 188
< openai-version: 2020-10-01
< strict-transport-security: max-age=15724800; includeSubDomains
< x-ratelimit-limit-requests: 3500
< x-ratelimit-remaining-requests: 3499
< x-ratelimit-reset-requests: 17ms
< x-request-id: a6656d804f2df32b5d33165cf079b10b
< cf-cache-status: DYNAMIC
< server: cloudflare
< cf-ray: 7bab090d09d18a98-NRT
< alt-svc: h3=":443"; ma=86400, h3-29=":443"; ma=86400
<
```

ã“ã“ã‹ã‚‰ã‚¤ãƒ™ãƒ³ãƒˆã‚¹ãƒˆãƒªãƒ¼ãƒ ã«ã‚¤ãƒ™ãƒ³ãƒˆãŒæµã‚Œã¦ãã¦ã©ã‚“ã©ã‚“ãƒ­ã‚°ãŒå‡ºã¦ãã¾ã™ã€‚
GPT ã® API ã§ã¯ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã¿ã®ãƒãƒ£ãƒ³ã‚¯ã« JSON ãƒ‡ãƒ¼ã‚¿ãŒæµã‚Œã¦ãã¦ã„ã¦ã€æœ€å¾Œã«`[DONE]`ã¨ç”ŸæˆãŒå®Œäº†ã—ãŸã“ã¨ã‚’ç¤ºã™ã‚¤ãƒ™ãƒ³ãƒˆãŒæµã‚Œã¦ã„ã¾ã—ãŸã€‚

```json:ã‚¤ãƒ™ãƒ³ãƒˆã‚¹ãƒˆãƒªãƒ¼ãƒ ã®ãƒ­ã‚°
data: {"id":"chatcmpl-77HGwVFc0IIclL2KCx51ic6bTG8Iv","object":"chat.completion.chunk","created":1681969046,"model":"gpt-3.5-turbo-0301","choices":[{"delta":{"role":"assistant"},"index":0,"finish_reason":null}]}

data: {"id":"chatcmpl-77HGwVFc0IIclL2KCx51ic6bTG8Iv","object":"chat.completion.chunk","created":1681969046,"model":"gpt-3.5-turbo-0301","choices":[{"delta":{"content":"ã“ã‚“ã«ã¡ã¯"},"index":0,"finish_reason":null}]}

data: {"id":"chatcmpl-77HGwVFc0IIclL2KCx51ic6bTG8Iv","object":"chat.completion.chunk","created":1681969046,"model":"gpt-3.5-turbo-0301","choices":[{"delta":{"content":"ã€"},"index":0,"finish_reason":null}]}

data: {"id":"chatcmpl-77HGwVFc0IIclL2KCx51ic6bTG8Iv","object":"chat.completion.chunk","created":1681969046,"model":"gpt-3.5-turbo-0301","choices":[{"delta":{"content":"ç§"},"index":0,"finish_reason":null}]}

data: {"id":"chatcmpl-77HGwVFc0IIclL2KCx51ic6bTG8Iv","object":"chat.completion.chunk","created":1681969046,"model":"gpt-3.5-turbo-0301","choices":[{"delta":{"content":"ã¯"},"index":0,"finish_reason":null}]}

data: {"id":"chatcmpl-77HGwVFc0IIclL2KCx51ic6bTG8Iv","object":"chat.completion.chunk","created":1681969046,"model":"gpt-3.5-turbo-0301","choices":[{"delta":{"content":"AI"},"index":0,"finish_reason":null}]}

data: {"id":"chatcmpl-77HGwVFc0IIclL2KCx51ic6bTG8Iv","object":"chat.completion.chunk","created":1681969046,"model":"gpt-3.5-turbo-0301","choices":[{"delta":{"content":"ã‚¢"},"index":0,"finish_reason":null}]}

data: {"id":"chatcmpl-77HGwVFc0IIclL2KCx51ic6bTG8Iv","object":"chat.completion.chunk","created":1681969046,"model":"gpt-3.5-turbo-0301","choices":[{"delta":{"content":"ã‚·"},"index":0,"finish_reason":null}]}

data: {"id":"chatcmpl-77HGwVFc0IIclL2KCx51ic6bTG8Iv","object":"chat.completion.chunk","created":1681969046,"model":"gpt-3.5-turbo-0301","choices":[{"delta":{"content":"ã‚¹"},"index":0,"finish_reason":null}]}

data: {"id":"chatcmpl-77HGwVFc0IIclL2KCx51ic6bTG8Iv","object":"chat.completion.chunk","created":1681969046,"model":"gpt-3.5-turbo-0301","choices":[{"delta":{"content":"ã‚¿"},"index":0,"finish_reason":null}]}

data: {"id":"chatcmpl-77HGwVFc0IIclL2KCx51ic6bTG8Iv","object":"chat.completion.chunk","created":1681969046,"model":"gpt-3.5-turbo-0301","choices":[{"delta":{"content":"ãƒ³ãƒˆ"},"index":0,"finish_reason":null}]}

data: {"id":"chatcmpl-77HGwVFc0IIclL2KCx51ic6bTG8Iv","object":"chat.completion.chunk","created":1681969046,"model":"gpt-3.5-turbo-0301","choices":[{"delta":{"content":"ã§ã™"},"index":0,"finish_reason":null}]}

data: {"id":"chatcmpl-77HGwVFc0IIclL2KCx51ic6bTG8Iv","object":"chat.completion.chunk","created":1681969046,"model":"gpt-3.5-turbo-0301","choices":[{"delta":{"content":"ã€‚"},"index":0,"finish_reason":null}]}

data: {"id":"chatcmpl-77HGwVFc0IIclL2KCx51ic6bTG8Iv","object":"chat.completion.chunk","created":1681969046,"model":"gpt-3.5-turbo-0301","choices":[{"delta":{"content":"ã©"},"index":0,"finish_reason":null}]}

data: {"id":"chatcmpl-77HGwVFc0IIclL2KCx51ic6bTG8Iv","object":"chat.completion.chunk","created":1681969046,"model":"gpt-3.5-turbo-0301","choices":[{"delta":{"content":"ã®"},"index":0,"finish_reason":null}]}

data: {"id":"chatcmpl-77HGwVFc0IIclL2KCx51ic6bTG8Iv","object":"chat.completion.chunk","created":1681969046,"model":"gpt-3.5-turbo-0301","choices":[{"delta":{"content":"ã‚ˆ"},"index":0,"finish_reason":null}]}

data: {"id":"chatcmpl-77HGwVFc0IIclL2KCx51ic6bTG8Iv","object":"chat.completion.chunk","created":1681969046,"model":"gpt-3.5-turbo-0301","choices":[{"delta":{"content":"ã†"},"index":0,"finish_reason":null}]}

data: {"id":"chatcmpl-77HGwVFc0IIclL2KCx51ic6bTG8Iv","object":"chat.completion.chunk","created":1681969046,"model":"gpt-3.5-turbo-0301","choices":[{"delta":{"content":"ã«"},"index":0,"finish_reason":null}]}

data: {"id":"chatcmpl-77HGwVFc0IIclL2KCx51ic6bTG8Iv","object":"chat.completion.chunk","created":1681969046,"model":"gpt-3.5-turbo-0301","choices":[{"delta":{"content":"ãŠ"},"index":0,"finish_reason":null}]}

data: {"id":"chatcmpl-77HGwVFc0IIclL2KCx51ic6bTG8Iv","object":"chat.completion.chunk","created":1681969046,"model":"gpt-3.5-turbo-0301","choices":[{"delta":{"content":"æ‰‹"},"index":0,"finish_reason":null}]}

data: {"id":"chatcmpl-77HGwVFc0IIclL2KCx51ic6bTG8Iv","object":"chat.completion.chunk","created":1681969046,"model":"gpt-3.5-turbo-0301","choices":[{"delta":{"content":"ä¼"},"index":0,"finish_reason":null}]}

data: {"id":"chatcmpl-77HGwVFc0IIclL2KCx51ic6bTG8Iv","object":"chat.completion.chunk","created":1681969046,"model":"gpt-3.5-turbo-0301","choices":[{"delta":{"content":"ã„"},"index":0,"finish_reason":null}]}

data: {"id":"chatcmpl-77HGwVFc0IIclL2KCx51ic6bTG8Iv","object":"chat.completion.chunk","created":1681969046,"model":"gpt-3.5-turbo-0301","choices":[{"delta":{"content":"ã§"},"index":0,"finish_reason":null}]}

data: {"id":"chatcmpl-77HGwVFc0IIclL2KCx51ic6bTG8Iv","object":"chat.completion.chunk","created":1681969046,"model":"gpt-3.5-turbo-0301","choices":[{"delta":{"content":"ã"},"index":0,"finish_reason":null}]}

data: {"id":"chatcmpl-77HGwVFc0IIclL2KCx51ic6bTG8Iv","object":"chat.completion.chunk","created":1681969046,"model":"gpt-3.5-turbo-0301","choices":[{"delta":{"content":"ã¾ã™"},"index":0,"finish_reason":null}]}

data: {"id":"chatcmpl-77HGwVFc0IIclL2KCx51ic6bTG8Iv","object":"chat.completion.chunk","created":1681969046,"model":"gpt-3.5-turbo-0301","choices":[{"delta":{"content":"ã‹"},"index":0,"finish_reason":null}]}

data: {"id":"chatcmpl-77HGwVFc0IIclL2KCx51ic6bTG8Iv","object":"chat.completion.chunk","created":1681969046,"model":"gpt-3.5-turbo-0301","choices":[{"delta":{"content":"ï¼Ÿ"},"index":0,"finish_reason":null}]}

data: {"id":"chatcmpl-77HGwVFc0IIclL2KCx51ic6bTG8Iv","object":"chat.completion.chunk","created":1681969046,"model":"gpt-3.5-turbo-0301","choices":[{"delta":{},"index":0,"finish_reason":"stop"}]}

data: [DONE]
```

ã“ã®å¾Œã«ã€ã‚µãƒ¼ãƒã‹ã‚‰ã®åˆ‡æ–­ã«ã‚ˆã£ã¦**TLS**ã®ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ã‚‚çµ‚äº†ã—ã¾ã—ãŸã€‚

```shell:ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ã®çµ‚äº†ãƒ­ã‚°
* Connection #0 to host api.openai.com left intact
```

ã“ã‚Œã§ç„¡äº‹ã«ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã‚’ã—ã¦ã€æµã‚Œã¦ããŸãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèªã§ãã¾ã—ãŸ ğŸ™ŒğŸ™ŒğŸ™ŒğŸ™Œ

## ãƒ–ãƒ©ã‚¦ã‚¶ã§å—ä¿¡ã—ã¦ã¿ã‚‹

ãƒ–ãƒ©ã‚¦ã‚¶ã§å—ä¿¡ã™ã‚‹ã«ã¯ã€**EventSource**ã‚’ç”¨ã„ã‚‹ã“ã¨ã§ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆãƒªãƒ¼ãƒ ã«æ¥ç¶šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
ãŒã€ä»Šå›ã¯ GPT ã® API ã‚’ä½¿ã„ãŸã„ã®ã§ã€`FetchAPI`ã‚’ä½¿ã„ã¾ã™ã€‚

ã¾ãšã¯ã€ã„ã¤ã‚‚é€šã‚Š`POST`ã§ API ã‚’å©ãã¾ã™ã€‚

```typescript
const res = await fetch("https://api.openai.com/v1/chat/completions", {
  headers: {
    "Content-Type": "application/json",
    Authorization: `Bearer sk-xxxx`,
  },
  method: "POST",
  body: JSON.stringify({
    messages: [
      {
        role: "user",
        content: "ã“ã‚“ã«ã¡ã¯",
      },
    ],
    model: "gpt-3.5-turbo",
    stream: true,
  }),
});
```

`res.body`ãŒ`ReadableStream`ãªã®ã§ã€ã“ã®ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿å–ã‚‹ãŸã‚ã®ãƒªãƒ¼ãƒ€ãƒ¼ã‚’å–å¾—ã—ã¾ã™ã€‚

```typescript
const reader = res.body.getReader();
```

ãƒªãƒ¼ãƒ€ãƒ¼ã®`read`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã¶ã¨ã€æ¬¡ã®ã‚¤ãƒ™ãƒ³ãƒˆãŒæµã‚Œã¦ããŸæ™‚ã«éåŒæœŸå‡¦ç†ãŒè§£æ±ºã•ã‚Œã‚‹ã®ã§ã€å®Œäº†ã«ãªã‚‹ã¾ã§èª­ã¿å–ã‚Šã‚’ç¶šã‘ã¾ã™ã€‚

```typescript
const decoder = new TextDecoder();

const read = async () => {
  const { done, value } = await reader.read();
  if (done) {
    return;
  }
  console.log(decoder.decode(value));
  return read();
};

await read();
```

æœ€å¾Œã«ã€ãƒªãƒ¼ãƒ€ãƒ¼ã‚’å–å¾—ã™ã‚‹ã¨ã€ãã®`ReadableStream`ã¯ãƒ­ãƒƒã‚¯çŠ¶æ…‹ã«ãªã£ã¦ã€ä»–ã®ãƒªãƒ¼ãƒ€ã‚’å–å¾—ã™ã‚‹ã“ã¨ãŒã§ããªã„ã®ã§è§£æ”¾ã—ã¦ãŠãã¾ã™ã€‚

```typescript
reader.releaseLock();
```

ã“ã‚Œã§ãƒ–ãƒ©ã‚¦ã‚¶ä¸Šã§ã‚‚ã€`cURL`ã§åˆ©ç”¨ã—ãŸã¨ãã¨åŒæ§˜ã«ã‚¤ãƒ™ãƒ³ãƒˆã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’å—ä¿¡ã§ããŸã¨æ€ã„ã¾ã™ï¼

## æœ€å¾Œã«

**GPT**ã®ä½“é¨“ã‚’æ”¯ãˆã‚‹**SSE**ã«ã¤ã„ã¦èª¿ã¹ã¦ã¿ã¦ã€ãã‚‚ãã‚‚ HTTP é€šä¿¡ã«ã¤ã„ã¦ä½•ã‚‚çŸ¥ã‚‰ãªã‹ã£ãŸã®ã§å‹‰å¼·ã«ãªã‚Šã¾ã—ãŸã€‚
ã¾ã ã¾ã ã‚ã‹ã‚‰ãªã„ã“ã¨ã ã‚‰ã‘ãªã®ã§ã€å‹‰å¼·ã—ã¤ã¤è¨˜äº‹ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã—ã¦ã„ã‘ãŸã‚‰ãªã¨æ€ã„ã¾ã™ã€‚

## å‚è€ƒè¨˜äº‹

https://developer.mozilla.org/ja/docs/Web/API/Server-sent_events
https://lonesec.com/2019/12/01/transfer-encoding/
https://developer.mozilla.org/ja/docs/Web/API/Server-sent_events/Using_server-sent_events
https://qiita.com/toshihirock/items/8d9d1cce4c04284be4c4
https://ably.com/blog/websockets-vs-sse
